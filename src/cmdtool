#!/bin/bash

set -e

cd "$(dirname $0)"

[[ $# == 0 || "$1" == "-h" || "$1" == "--help" ]] && {
    echo -e "Usage: $0 [OPTION]..."\
        "\n  update: check the latest wsl-terminal version, and upgrade it."\
        "\n  killall: kill all WSL process."\
        "\n  install cbwin: install cbwin."\
        "\n  install dash: install dash (for debugging)."\
        "\n  install busybox: install busybox (for debugging)."

    exit
}

op=$1

if [[ "$1" == update ]]; then
    version=$(cat VERSION)
    echo Checking the latest version ...
    latest_version=$(wget https://raw.githubusercontent.com/goreliu/wsl-terminal/master/VERSION -O -)
    if [[ "$version" == "$latest_version" ]]; then
        echo Already the latest version: $version
        exit
    fi

    echo -n "Upgrade [$version] to [$latest_version]? (y/n)"
    read -n1 answer 
    if [[ "$answer" != "y" ]]; then
        exit
    fi

    filename=wsl-terminal-$latest_version.7z

    if [[ ! -e "$filename" ]]; then
        wget -c "https://github.com/goreliu/wsl-terminal/releases/download/v$latest_version/wsl-terminal-$latest_version.7z"
    fi

    rm -rf wsl-terminal
    7z x $filename || {
        echo "$filename is broken, try again."
        rm -v $filename
        exit 1
    }

    mv -v wsl-terminal/tools/* tools/
    mv -v wsl-terminal/etc/wsl-terminal.conf etc/wsl-terminal.conf.pacnew
    mv -v wsl-terminal/etc/minttyrc etc/minttyrc.pacnew
    mv -v wsl-terminal/etc/lang/* etc/lang/
    mv -v wsl-terminal/etc/themes/* etc/themes/
    mv -v wsl-terminal/etc/README.md etc/

    cd wsl-terminal/bin
    for i in *; do
        mv ../../bin/$i ../../bin/$i.$$.bak
        mv -v $i ../../bin/$i
        rm -f ../../bin/*.bak 2>/dev/null || true
    done
    cd ../..

    rm -rf doc
    mv -v wsl-terminal/doc .
    mv -v wsl-terminal/{*.*,cmdtool,VERSION} .

    rm -rf wsl-terminal
    rm $filename
    echo OK
    exit
elif [[ "$1" == "killall" ]]; then
    killall sleep wslbridge-backend bash tmux zsh
elif [[ "$1" == "install" ]]; then
    if [[ "$2" == "cbwin" ]]; then
        wget https://github.com/xilun/cbwin/releases/download/v0.13/cbwin-bin-0.13.zip
        7z x cbwin-bin-0.13.zip
        cd cbwin-bin-0.13
        mv -v outbash.exe w* ../bin/
        mv -v install.sh ../bin/install_cbwin.sh
        mkdir ../doc/cbwin
        mv -v LICENSE README.md ../doc/cbwin
        cd ..
        rm -rf cbwin-bin-0.13
        rm -f cbwin-bin-0.13.zip
        echo Add use_cbwin=1 to etc/wsl-terminal.conf to use cbwin.
        echo OK
    elif [[ "$2" == "dash" ]]; then
        version=0.5.9.1-1
        wget http://mirrors.ustc.edu.cn/cygwin/x86_64/release/dash/dash-$version.tar.xz 
        tar -xvf dash-$version.tar.xz usr/bin/ash.exe
        cp -v usr/bin/ash.exe bin/dash.exe
        # mintty need a bash.exe if running with no args.
        mv -v usr/bin/ash.exe bin/bash.exe
        rm -rf usr dash-$version.tar.xz
        echo OK
    elif [[ "$2" == "busybox" ]]; then
        version=1.23.2-1
        wget http://mirrors.ustc.edu.cn/cygwin/x86_64/release/busybox/busybox-$version.tar.xz
        tar -xvf busybox-$version.tar.xz usr/libexec/busybox/bin/busybox.exe
        mv -v usr/libexec/busybox/bin/busybox.exe bin/busybox.exe
        rm -rf usr busybox-$version.tar.xz
        echo OK
    fi
fi
